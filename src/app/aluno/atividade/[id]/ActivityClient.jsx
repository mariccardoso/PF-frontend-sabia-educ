"use client";
import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import axios from "axios";
import styles from "./atividade.module.css";

const API_URL = "http://localhost:5000";

export default function ActivityClient({ activityId }) {
  const router = useRouter();
  const [user, setUser] = useState(null);
  const [activity, setActivity] = useState(null);
  const [progress, setProgress] = useState(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [score, setScore] = useState(0);

  useEffect(() => {
    const storedUser = localStorage.getItem("user");
    const token = localStorage.getItem("token");
    if (!storedUser || !token) {
      router.push("/");
      return;
    }
    const parsedUser = JSON.parse(storedUser);
    setUser(parsedUser);

    loadActivityData(parsedUser.id, token);
  }, [activityId]);

  const loadActivityData = async (userIdRaw, token) => {
    try {
      const userId = Number(userIdRaw);
      console.log("Carregando dados da atividade:", { userId, activityId });

      // Buscar atividade
      const activityRes = await axios.get(`${API_URL}/activities/${activityId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      console.log("Atividade carregada:", activityRes.data);
      setActivity(activityRes.data);

      // Buscar progresso do usu√°rio
      const progressRes = await axios.get(`${API_URL}/progress`, {
        headers: { Authorization: `Bearer ${token}` },
        params: { userId, activityId: Number(activityId) },
      });
      
      console.log("Resposta do progresso:", progressRes.data);

      let prog = null;
      if (Array.isArray(progressRes.data)) {
        prog = progressRes.data.find(p => 
          p.userId === userId && p.activityId === Number(activityId)
        );
      } else if (progressRes.data.progress && Array.isArray(progressRes.data.progress)) {
        prog = progressRes.data.progress.find(p => 
          p.userId === userId && p.activityId === Number(activityId)
        );
      }

      console.log("Progresso encontrado:", prog);

      // Se n√£o existe, cria com In_Progress
      if (!prog) {
        try {
          console.log("Criando novo progresso inicial...");
          const newProgRes = await axios.post(
            `${API_URL}/progress`,
            { 
              userId, 
              activityId: Number(activityId), 
              status: "In_Progress",
              score: 0
            },
            { 
              headers: { 
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              } 
            }
          );
          prog = newProgRes.data;
          console.log("Novo progresso criado:", prog);
        } catch (createErr) {
          console.error("Erro ao criar progresso inicial:", createErr);
          console.error("Response:", createErr.response?.data);
        }
      }

      setProgress(prog);
      setLoading(false);
    } catch (err) {
      console.error("Erro ao carregar atividade:", err);
      console.error("Response status:", err.response?.status);
      console.error("Response data:", err.response?.data);
      setLoading(false);
      
      if (err.response?.status === 401) {
        localStorage.clear();
        router.push("/");
      }
    }
  };

  const handleComplete = async () => {
    if (!user || !activity || !progress) {
      alert("Dados incompletos. Tente recarregar a p√°gina.");
      return;
    }

    const token = localStorage.getItem("token");
    if (!token) {
      alert("Sess√£o expirada. Fa√ßa login novamente.");
      router.push("/");
      return;
    }

    // Validar score
    const finalScore = Math.max(0, Math.min(100, Number(score) || 0));
    setSaving(true);
    
    try {
      console.log("Tentando atualizar progresso:", {
        progressId: progress.id,
        progressObj: progress,
        userId: user.id,
        activityId: activity.id,
        status: "Completed",
        score: finalScore,
        url: `${API_URL}/progress/${progress.id}`
      });

      // Testar se o endpoint existe primeiro
      try {
        const testRes = await axios.get(`${API_URL}/progress/${progress.id}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        console.log("Progresso encontrado no servidor:", testRes.data);
      } catch (testErr) {
        console.log("Erro ao buscar progresso espec√≠fico:", testErr.response?.status);
        if (testErr.response?.status === 404) {
          throw new Error("Progress not found, will create new one");
        }
      }

      const updated = await axios.put(
        `${API_URL}/progress/${progress.id}`,
        { 
          status: "Completed", 
          score: finalScore
        },
        { 
          headers: { 
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          } 
        }
      );
      
      console.log("Progresso atualizado com sucesso:", updated.data);
      setProgress(updated.data);
      alert(`üéâ Parab√©ns! Atividade conclu√≠da com ${finalScore}% de aproveitamento!`);
      
      // Redirecionar ap√≥s 2 segundos
      setTimeout(() => {
        router.push('/aluno');
      }, 2000);
      
    } catch (err) {
      console.error("Erro completo:", err);
      console.error("Response data:", err.response?.data);
      console.error("Response status:", err.response?.status);
      console.error("Request config:", err.config);
      
      if (err.response?.status === 401) {
        alert("Sess√£o expirada. Fa√ßa login novamente.");
        localStorage.clear();
        router.push("/");
      } else if (err.response?.status === 404) {
        alert("Progresso n√£o encontrado. Tentando criar novo registro...");
        await createNewProgress(finalScore, token);
      } else if (err.response?.status === 500) {
        console.log("Erro 500 no PUT, tentando PATCH...");
        try {
          const patchUpdated = await axios.patch(
            `${API_URL}/progress/${progress.id}`,
            { 
              status: "Completed", 
              score: finalScore
            },
            { 
              headers: { 
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              } 
            }
          );
          console.log("PATCH funcionou:", patchUpdated.data);
          setProgress(patchUpdated.data);
          alert(`üéâ Parab√©ns! Atividade conclu√≠da com ${finalScore}% de aproveitamento!`);
          setTimeout(() => {
            router.push('/aluno');
          }, 2000);
        } catch (patchErr) {
          console.log("PATCH tamb√©m falhou:", patchErr.response?.data);
          console.log("Tentando PUT apenas com score...");
          try {
            const scoreOnly = await axios.put(
              `${API_URL}/progress/${progress.id}`,
              { score: finalScore },
              { 
                headers: { 
                  Authorization: `Bearer ${token}`,
                  'Content-Type': 'application/json'
                } 
              }
            );
            console.log("PUT apenas com score funcionou:", scoreOnly.data);
            setProgress(scoreOnly.data);
            alert(`‚úÖ Pontua√ß√£o salva: ${finalScore}%`);
            setTimeout(() => {
              router.push('/aluno');
            }, 2000);
          } catch (scoreErr) {
            console.log("PUT apenas com score falhou, criando novo progresso...");
            await createNewProgress(finalScore, token);
          }
        }
      } else if (err.message === "Progress not found, will create new one") {
        console.log("Progresso n√£o existe, criando novo...");
        await createNewProgress(finalScore, token);
      } else {
        alert("Erro ao salvar progresso. Tente novamente.");
      }
    } finally {
      setSaving(false);
    }
  };

  const createNewProgress = async (finalScore, token) => {
    try {
      console.log("Criando novo progresso:", {
        userId: Number(user.id),
        activityId: Number(activity.id),
        status: "Completed",
        score: finalScore
      });

      const newProgress = await axios.post(
        `${API_URL}/progress`,
        {
          userId: Number(user.id),
          activityId: Number(activity.id),
          status: "Completed",
          score: finalScore
        },
        {
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      console.log("Novo progresso criado:", newProgress.data);
      setProgress(newProgress.data);
      alert(`üéâ Atividade conclu√≠da com sucesso! Pontua√ß√£o: ${finalScore}%`);
      
      setTimeout(() => {
        router.push('/aluno');
      }, 2000);
      
    } catch (createErr) {
      console.error("Erro ao criar novo progresso:", createErr);
      console.error("Detalhes do erro:", createErr.response?.data);
      console.error("Status do erro:", createErr.response?.status);
      
      // Se o POST falhar com 500, tentar apenas com dados m√≠nimos (sem userId)
      if (createErr.response?.status === 500) {
        try {
          console.log("POST falhou, tentando sem userId...");
          const minimalProgress = await axios.post(
            `${API_URL}/progress`,
            {
              activityId: Number(activity.id),
              status: "Completed",
              score: finalScore
            },
            {
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            }
          );
          
          console.log("Progresso criado sem userId:", minimalProgress.data);
          setProgress(minimalProgress.data);
          alert(`‚úÖ Atividade registrada como conclu√≠da! Pontua√ß√£o: ${finalScore}%`);
          
          setTimeout(() => {
            router.push('/aluno');
          }, 2000);
          
        } catch (minimalErr) {
          console.error("Cria√ß√£o m√≠nima tamb√©m falhou:", minimalErr);
          console.error("Detalhes erro m√≠nimo:", minimalErr.response?.data);
          alert("N√£o foi poss√≠vel salvar o progresso. Entre em contato com o suporte.");
        }
      } else {
        alert("N√£o foi poss√≠vel salvar o progresso. Entre em contato com o suporte.");
      }
    } finally {
      setSaving(false);
    }
  };

  if (loading) return <p className={styles.loading}>Carregando atividade...</p>;
  if (!activity) return <p className={styles.error}>Atividade n√£o encontrada</p>;

  const getActivityIcon = (type) => {
    switch (type) {
      case 'Quiz': return 'üß©';
      case 'MemoryGame': return 'üß†';
      case 'Drag_and_Drop': return 'üéØ';
      default: return 'üìö';
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'Completed': return styles.completed;
      case 'In_Progress': return styles.inProgress;
      case 'Not_Started': return styles.notStarted;
      default: return '';
    }
  };

  return (
    <div className={styles.container}>
      {/* Cabe√ßalho da atividade */}
      <header className={styles.header}>
        <div className={styles.activityIcon}>
          {getActivityIcon(activity.type)}
        </div>
        <div className={styles.activityInfo}>
          <h1>{activity.title}</h1>
          <p>{activity.description}</p>
          <span className={styles.difficulty}>{activity.difficulty}</span>
        </div>
      </header>

      {/* Status atual */}
      <div className={styles.statusCard}>
        <h3>Status da Atividade</h3>
        <div className={`${styles.statusBadge} ${getStatusColor(progress?.status || 'Not_Started')}`}>
          <span className={styles.statusIcon}>
            {progress?.status === 'Completed' ? '‚úÖ' : 
             progress?.status === 'In_Progress' ? 'üîÑ' : '‚è≥'}
          </span>
          <span className={styles.statusText}>
            {progress?.status === 'Completed' ? 'Conclu√≠do' : 
             progress?.status === 'In_Progress' ? 'Em andamento' : 'N√£o iniciado'}
          </span>
          {progress?.status === 'Completed' && progress?.score && (
            <span className={styles.scoreDisplay}>
              Nota: {progress.score}%
            </span>
          )}
        </div>
      </div>

      {/* √Årea da atividade */}
      <div className={styles.activityBox}>
        {activity.type === "Quiz" && (
          <div className={styles.quiz}>
            <h3>üìù Question√°rio Interativo</h3>
            <p>Responda as quest√µes para testar seus conhecimentos!</p>
            
            <div className={styles.quizSection}>
              <div className={styles.questionCard}>
                <p className={styles.question}>Qual √© a cor do sol? ‚òÄÔ∏è</p>
                <div className={styles.options}>
                  <button className={styles.option}>üü° Amarelo</button>
                  <button className={styles.option}>üîµ Azul</button>
                  <button className={styles.option}>üî¥ Vermelho</button>
                  <button className={styles.option}>üü¢ Verde</button>
                </div>
              </div>
            </div>

            <div className={styles.scoreInput}>
              <label>Pontua√ß√£o obtida:</label>
              <input
                type="number"
                min="0"
                max="100"
                placeholder="Digite sua nota (0-100)"
                value={score}
                onChange={(e) => setScore(Number(e.target.value))}
                className={styles.scoreField}
              />
            </div>
          </div>
        )}

        {activity.type === "MemoryGame" && (
          <div className={styles.memory}>
            <h3>üß† Jogo da Mem√≥ria</h3>
            <p>Encontre os pares iguais para completar o desafio!</p>
            
            <div className={styles.memoryGrid}>
              <div className={styles.memoryCard}>üçé</div>
              <div className={styles.memoryCard}>üçå</div>
              <div className={styles.memoryCard}>üçé</div>
              <div className={styles.memoryCard}>üçå</div>
              <div className={styles.memoryCard}>üçì</div>
              <div className={styles.memoryCard}>üçì</div>
            </div>

            <div className={styles.scoreInput}>
              <label>Pontua√ß√£o obtida:</label>
              <input
                type="number"
                min="0"
                max="100"
                placeholder="Digite sua nota (0-100)"
                value={score}
                onChange={(e) => setScore(Number(e.target.value))}
                className={styles.scoreField}
              />
            </div>
          </div>
        )}

        {activity.type === "Drag_and_Drop" && (
          <div className={styles.dragdrop}>
            <h3>üéØ Arrastar e Soltar</h3>
            <p>Arraste os elementos para a posi√ß√£o correta!</p>
            
            <div className={styles.dragArea}>
              <div className={styles.dragItems}>
                <div className={styles.dragItem}>üåÖ Manh√£</div>
                <div className={styles.dragItem}>üåû Tarde</div>
                <div className={styles.dragItem}>üåô Noite</div>
              </div>
              
              <div className={styles.dropZones}>
                <div className={styles.dropZone}>1¬∫</div>
                <div className={styles.dropZone}>2¬∫</div>
                <div className={styles.dropZone}>3¬∫</div>
              </div>
            </div>

            <div className={styles.scoreInput}>
              <label>Pontua√ß√£o obtida:</label>
              <input
                type="number"
                min="0"
                max="100"
                placeholder="Digite sua nota (0-100)"
                value={score}
                onChange={(e) => setScore(Number(e.target.value))}
                className={styles.scoreField}
              />
            </div>
          </div>
        )}
      </div>

      {/* Bot√£o de conclus√£o */}
      <div className={styles.actionArea}>
        <button 
          onClick={handleComplete} 
          className={styles.completeBtn}
          disabled={progress?.status === 'Completed' || saving}
        >
          {saving ? 'üíæ Salvando...' : 
           progress?.status === 'Completed' ? '‚úÖ J√° Conclu√≠do!' : 
           'üéâ Finalizar Atividade'}
        </button>
      </div>
    </div>
  );
}
